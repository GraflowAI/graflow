# Human-in-the-Loop (HITL) è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.3
**æ—¥ä»˜**: 2025-01-28
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆç¢ºå®š

**å¤‰æ›´å±¥æ­´**:
- v1.3: ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥æ©Ÿèƒ½è¿½åŠ 
  - ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆUUIDï¼‰ã®è¡¨ç¤ºæ©Ÿèƒ½
  - æ±ç”¨Webhooké€šçŸ¥ã‚µãƒãƒ¼ãƒˆï¼ˆSlackå«ã‚€å…¨ã¦ã®Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå¯¾å¿œï¼‰
  - FeedbackRequestã«`notification_config`ã‚’è¿½åŠ 
  - è¤‡æ•°é€šçŸ¥ã‚¿ã‚¤ãƒ—ã®ã‚µãƒãƒ¼ãƒˆï¼ˆæ±ç”¨Webhookã€ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼‰
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
- v1.2: å®Ÿè£…ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ç¢ºå®š
  - ã‚ªãƒ—ã‚·ãƒ§ãƒ³6ï¼ˆé€šçŸ¥ï¼‰: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆPub/Sub + ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ã‚’æ¡ç”¨
  - ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å®Ÿè£…ã®è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆæ“¬ä¼¼ã‚³ãƒ¼ãƒ‰ã¨ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼‰
  - åˆ†æ•£å®Ÿè¡Œç”¨ã«Redisãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ç¢ºå®š
  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œè¨­è¨ˆç¢ºå®šã€ã«å¤‰æ›´
- v1.1: ãƒãƒ£ãƒãƒ«çµ±åˆã‚µãƒãƒ¼ãƒˆè¿½åŠ 
  - FeedbackRequestã«`channel_key`ã¨`write_to_channel`ã‚’è¿½åŠ 
  - FeedbackManager.provide_feedback()ã«ãƒãƒ£ãƒãƒ«è‡ªå‹•æ›¸ãè¾¼ã¿æ©Ÿèƒ½ã‚’è¿½åŠ 
  - ãƒãƒ£ãƒãƒ«çµ±åˆã®ä¾‹ã‚’è¿½åŠ ï¼ˆä¾‹5ï¼‰
  - TaskExecutionContextã®ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒãƒ£ãƒãƒ«çµ±åˆå¯¾å¿œã«æ›´æ–°
- v1.0: åˆæœŸè¨­è¨ˆ

---

## ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [å‹•æ©Ÿ](#å‹•æ©Ÿ)
3. [è¦ä»¶](#è¦ä»¶)
4. [è¨­è¨ˆç›®æ¨™](#è¨­è¨ˆç›®æ¨™)
5. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
6. [APIè¨­è¨ˆ](#apiè¨­è¨ˆ)
7. [å®Ÿè£…è©³ç´°](#å®Ÿè£…è©³ç´°)
8. [é€šçŸ¥ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ](#é€šçŸ¥ãƒ¡ã‚«ãƒ‹ã‚ºãƒ )
9. [ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ](#ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ )
10. [ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆçµ±åˆ](#ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆçµ±åˆ)
11. [ã‚¯ãƒ­ã‚¹ãƒ—ãƒ­ã‚»ã‚¹é€šä¿¡](#ã‚¯ãƒ­ã‚¹ãƒ—ãƒ­ã‚»ã‚¹é€šä¿¡)
12. [ä½¿ç”¨ä¾‹](#ä½¿ç”¨ä¾‹)
13. [ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã¨åˆ¶é™äº‹é …](#ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã¨åˆ¶é™äº‹é …)
14. [å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)

---

## æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Graflowãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãŸã‚ã®äººé–“ä»‹å…¥ï¼ˆHITLï¼‰æ©Ÿèƒ½ã®è¨­è¨ˆã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚HITLæ©Ÿèƒ½ã«ã‚ˆã‚Šã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å®Ÿè¡Œã‚’ä¸€æ™‚åœæ­¢ã—ã¦äººé–“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¾…ã£ã¦ã‹ã‚‰ç¶šè¡Œã§ãã¾ã™ã€‚å³åº§ã®å¿œç­”ã¨é…å»¶å¿œç­”ã®ä¸¡æ–¹ã‚’ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã«å‡¦ç†ã—ã¾ã™ã€‚

### ä¸»è¦æ©Ÿèƒ½

1. **è¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒ—**: æ‰¿èªã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã€é¸æŠã€ã‚«ã‚¹ã‚¿ãƒ 
2. **ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†**: å³åº§ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ã®çŸ­æœŸãƒãƒ¼ãƒªãƒ³ã‚°ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆ
3. **ã‚¯ãƒ­ã‚¹ãƒ—ãƒ­ã‚»ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯**: API/GUIã‹ã‚‰å®Ÿè¡Œä¸­ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¸ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æä¾›
4. **æ°¸ç¶šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯çŠ¶æ…‹**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•å¾Œã‚‚ä¿æŒ
5. **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆçµ±åˆ**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å—ä¿¡å¾Œã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã®ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªå†é–‹
6. **ãƒãƒ£ãƒãƒ«çµ±åˆ**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒãƒ«ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¿œç­”ã®è‡ªå‹•æ›¸ãè¾¼ã¿ã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯é–“é€šä¿¡
7. **æ±ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è¡¨ç¤ºã€æ±ç”¨Webhookï¼ˆSlackç­‰ï¼‰/ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å¯¾å¿œ

---

## å‹•æ©Ÿ

### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

1. **æ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: é‡è¦ãªæ“ä½œï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã€æ”¯æ‰•ã„ãªã©ï¼‰ã®å®Ÿè¡Œå‰ã«äººé–“ã®æ‰¿èªãŒå¿…è¦
2. **ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼**: MLäºˆæ¸¬ã‚„ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯ã®äººé–“ã«ã‚ˆã‚‹æ¤œè¨¼
3. **ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œä¸­ã®äººé–“ã«ã‚ˆã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´
4. **ã‚¨ãƒ©ãƒ¼ãƒªã‚«ãƒãƒª**: ã‚¨ãƒ©ãƒ¼ã‚’äººé–“ã«æç¤ºã—ã¦åˆ¤æ–­ã‚’æ±‚ã‚ã‚‹ï¼ˆãƒªãƒˆãƒ©ã‚¤ã€ã‚¹ã‚­ãƒƒãƒ—ã€ä¸­æ­¢ï¼‰
5. **ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**: åå¾©çš„ãªäººé–“å…¥åŠ›ã‚’å¿…è¦ã¨ã™ã‚‹LLMãƒ™ãƒ¼ã‚¹ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
6. **ãƒãƒƒãƒå‡¦ç†**: ãƒãƒƒãƒå‡¦ç†çµæœã®å®šæœŸçš„ãªäººé–“ãƒ¬ãƒ“ãƒ¥ãƒ¼

### ã‚·ãƒŠãƒªã‚ªä¾‹

**ã‚·ãƒŠãƒªã‚ª1: å³åº§ã®æ‰¿èªï¼ˆ3åˆ†ä»¥å†…ï¼‰**
```
ã‚¿ã‚¹ã‚¯ãŒæ‰¿èªã‚’è¦æ±‚ â†’ ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ3åˆ†ï¼‰ â†’ äººé–“ãŒæ‰¿èª â†’ ã‚¿ã‚¹ã‚¯ç¶™ç¶š
```

**ã‚·ãƒŠãƒªã‚ª2: é…å»¶æ‰¿èªï¼ˆæ•°æ™‚é–“/æ•°æ—¥ï¼‰**
```
ã‚¿ã‚¹ã‚¯ãŒæ‰¿èªã‚’è¦æ±‚ â†’ ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ3åˆ†ï¼‰ â†’ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
â†’ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆ â†’ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼çµ‚äº†
â†’ ï¼ˆå¾Œã§ï¼‰äººé–“ãŒAPIã§æ‰¿èª â†’ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å†é–‹
â†’ æ‰¿èªã‚’å—ã‘ã¦ã‚¿ã‚¹ã‚¯ç¶™ç¶š
```

**ã‚·ãƒŠãƒªã‚ª3: åˆ†æ•£å®Ÿè¡Œ**
```
ãƒ¯ãƒ¼ã‚«ãƒ¼1: ã‚¿ã‚¹ã‚¯ãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¦æ±‚ â†’ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ â†’ ãƒ¯ãƒ¼ã‚«ãƒ¼çµ‚äº†
â†’ äººé–“ãŒAPIã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æä¾›ï¼ˆRedisã«ä¿å­˜ï¼‰
â†’ ãƒ¯ãƒ¼ã‚«ãƒ¼2: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å†é–‹ â†’ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾— â†’ ç¶™ç¶š
```

---

## è¦ä»¶

### æ©Ÿèƒ½è¦ä»¶

**FR1**: ã‚¿ã‚¹ã‚¯ã¯`context.request_feedback()`ã‚’ä½¿ç”¨ã—ã¦äººé–“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦æ±‚ã§ãã‚‹
**FR2**: è¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒ—: æ‰¿èªã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã€é¸æŠã€ã‚«ã‚¹ã‚¿ãƒ 
**FR3**: å³åº§ã®å¿œç­”ç”¨ã®çŸ­æœŸãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆè¨­å®šå¯èƒ½ãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3åˆ†ï¼‰
**FR4**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆ
**FR5**: å¤–éƒ¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡ç”¨ã®REST API
**FR6**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯çŠ¶æ…‹ã¯ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•å¾Œã‚‚ä¿æŒ
**FR7**: Memoryã¨Redisãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¸¡æ–¹ã‚’ã‚µãƒãƒ¼ãƒˆ
**FR8**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¿œç­”ã¯ç•°ãªã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰æä¾›å¯èƒ½

### éæ©Ÿèƒ½è¦ä»¶

**NFR1**: HITLä»¥å¤–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¸ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã‚’æœ€å°é™ã«
**NFR2**: ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç®¡ç†
**NFR3**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯APIçµŒç”±ã§ã‚¯ã‚¨ãƒªå¯èƒ½
**NFR4**: æ˜ç¢ºãªã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‹•ä½œï¼ˆç„¡é™ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãªã—ï¼‰

---

## è¨­è¨ˆç›®æ¨™

1. **ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°**: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¾…ã£ã¦ç„¡é™ã«ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
2. **æ°¸ç¶šæ€§**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯çŠ¶æ…‹ã¯ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•å¾Œã‚‚ä¿æŒ
3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: åˆ†æ•£å®Ÿè¡Œï¼ˆè¤‡æ•°ãƒ¯ãƒ¼ã‚«ãƒ¼ï¼‰ã«å¯¾å¿œ
4. **æŸ”è»Ÿæ€§**: è¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒ—ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
5. **ã‚·ãƒ³ãƒ—ãƒ«ãªAPI**: ã‚¿ã‚¹ã‚¯ã‹ã‚‰ç°¡å˜ã«ä½¿ç”¨å¯èƒ½
6. **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆå¯¾å¿œ**: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ/å†é–‹ã¨ã®ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªçµ±åˆ

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### é«˜ãƒ¬ãƒ™ãƒ«ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚¹ã‚¯ã‚³ãƒ¼ãƒ‰                        â”‚
â”‚                                                              â”‚
â”‚  @task(inject_context=True)                                 â”‚
â”‚  def my_task(context):                                      â”‚
â”‚      response = context.request_feedback(                   â”‚
â”‚          feedback_type="approval",                          â”‚
â”‚          prompt="ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ",                    â”‚
â”‚          timeout=180  # 3åˆ†                                 â”‚
â”‚      )                                                       â”‚
â”‚      if response.approved:                                  â”‚
â”‚          deploy()                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              TaskExecutionContext                           â”‚
â”‚  .request_feedback() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                     â”‚
                                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FeedbackManager                                â”‚
â”‚                                                              â”‚
â”‚  1. FeedbackRequestä½œæˆ                                     â”‚
â”‚  2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆMemory/Redisï¼‰ã«ä¿å­˜                        â”‚
â”‚  3. ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—é–‹å§‹ï¼ˆtimeout=180ç§’ / 3åˆ†ï¼‰              â”‚
â”‚     â”œâ”€> å¿œç­”ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°                                     â”‚
â”‚     â”œâ”€> å¿œç­”å—ä¿¡æ™‚: FeedbackResponseã‚’è¿”ã™                  â”‚
â”‚     â””â”€> ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚: FeedbackTimeoutExceptionç™ºç”Ÿ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WorkflowEngine                                 â”‚
â”‚                                                              â”‚
â”‚  FeedbackTimeoutExceptionã‚’ã‚­ãƒ£ãƒƒãƒ:                        â”‚
â”‚  1. ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆï¼ˆç¾åœ¨ã®ã‚¿ã‚¹ã‚¯ã¯æœªå®Œäº†ï¼‰              â”‚
â”‚  2. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’çµ‚äº†                                   â”‚
â”‚  3. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä¿æŒï¼ˆä¿ç•™ä¸­ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤–éƒ¨API/GUI                                    â”‚
â”‚                                                              â”‚
â”‚  POST /api/feedback/{feedback_id}/respond                   â”‚
â”‚  {                                                           â”‚
â”‚    "approved": true,                                        â”‚
â”‚    "reason": "å•é¡Œãªã—"                                      â”‚
â”‚  }                                                           â”‚
â”‚                                                              â”‚
â”‚  1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®FeedbackRequestã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°            â”‚
â”‚  2. FeedbackResponseã‚’ä¿å­˜                                  â”‚
â”‚  3. é€šçŸ¥ã‚’ç™ºè¡Œï¼ˆRedis Pub/Subï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å†é–‹                          â”‚
â”‚                                                              â”‚
â”‚  1. CheckpointManager.resume_from_checkpoint(path)          â”‚
â”‚  2. ã‚¨ãƒ³ã‚¸ãƒ³ãŒä¿ç•™ä¸­ã®ã‚¿ã‚¹ã‚¯ã‹ã‚‰å†èµ·å‹•                         â”‚
â”‚  3. ã‚¿ã‚¹ã‚¯ãŒå†åº¦request_feedback()ã‚’å‘¼ã³å‡ºã™                 â”‚
â”‚  4. FeedbackManagerãŒæ—¢å­˜ã®å¿œç­”ã‚’è¦‹ã¤ã‘ã‚‹                    â”‚
â”‚  5. å¿œç­”ã‚’å³åº§ã«è¿”ã™ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ãªã—ï¼‰                        â”‚
â”‚  6. ã‚¿ã‚¹ã‚¯ãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ã¨ã‚‚ã«ç¶™ç¶š                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## APIè¨­è¨ˆ

### ã‚³ã‚¢ã‚¯ãƒ©ã‚¹

#### FeedbackType

```python
from enum import Enum

class FeedbackType(Enum):
    """è¦æ±‚å¯èƒ½ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã‚¿ã‚¤ãƒ—"""
    APPROVAL = "approval"        # çœŸå½å€¤ã®æ‰¿èªï¼ˆæ‰¿èª/æ‹’å¦ï¼‰
    TEXT = "text"                # è‡ªç”±å½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
    SELECTION = "selection"      # ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®å˜ä¸€é¸æŠ
    MULTI_SELECTION = "multi_selection"  # è¤‡æ•°é¸æŠ
    CUSTOM = "custom"            # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ§‹é€ 
```

#### NotificationType

```python
class NotificationType(Enum):
    """é€šçŸ¥ã®ã‚¿ã‚¤ãƒ—"""
    CONSOLE = "console"          # ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã®ã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    WEBHOOK = "webhook"          # æ±ç”¨Webhookï¼ˆSlack, Discord, Teamsç­‰ï¼‰
    CUSTOM = "custom"            # ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
```

#### NotificationConfig

```python
from pydantic import BaseModel, Field

class NotificationConfig(BaseModel):
    """é€šçŸ¥è¨­å®š"""
    notification_type: NotificationType = NotificationType.CONSOLE

    # API URLè¨­å®šï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã‚’å«ã‚ã‚‹ï¼‰
    api_base_url: Optional[str] = None  # ä¾‹: "https://api.example.com"

    # æ±ç”¨Webhookè¨­å®š
    webhook_url: Optional[str] = None          # Webhook URLï¼ˆSlack, Discord, ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç­‰ï¼‰
    webhook_method: str = "POST"               # HTTPãƒ¡ã‚½ãƒƒãƒ‰
    webhook_headers: Optional[dict[str, str]] = None  # ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼
    webhook_payload_template: Optional[str] = None    # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆJinja2å½¢å¼ï¼‰
    webhook_retry_count: int = 3               # ãƒªãƒˆãƒ©ã‚¤å›æ•°
    webhook_timeout: int = 5                   # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰

    # HMACç½²åï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
    webhook_secret: Optional[str] = None       # HMAC-SHA256ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ

    # ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    custom_handler: Optional[Callable] = None  # ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥é–¢æ•°

    def to_dict(self) -> dict[str, Any]:
        """è¾æ›¸ã«å¤‰æ›ï¼ˆã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰"""
        data = self.model_dump()
        data["notification_type"] = self.notification_type.value
        return data
```

#### FeedbackRequest

```python
from pydantic import BaseModel, Field
from datetime import datetime
from typing import Any, Optional

class FeedbackRequest(BaseModel):
    """ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡¨ã™"""
    feedback_id: str                    # ä¸€æ„ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆID
    task_id: str                        # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦æ±‚ã™ã‚‹ã‚¿ã‚¹ã‚¯
    session_id: str                     # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
    feedback_type: FeedbackType         # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã‚¿ã‚¤ãƒ—
    prompt: str                         # äººé–“ã¸ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    options: Optional[list[str]] = None # é¸æŠã‚¿ã‚¤ãƒ—ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    metadata: dict[str, Any] = Field(default_factory=dict)  # ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    created_at: str = Field(default_factory=lambda: datetime.now().isoformat())
    timeout: float = 180.0              # ãƒãƒ¼ãƒªãƒ³ã‚°ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3åˆ†ï¼‰
    status: str = "pending"             # pending, completed, timeout, cancelled

    # ãƒãƒ£ãƒãƒ«çµ±åˆ
    channel_key: Optional[str] = None   # å¿œç­”ã‚’æ›¸ãè¾¼ã‚€ãƒãƒ£ãƒãƒ«ã‚­ãƒ¼
    write_to_channel: bool = False      # ãƒãƒ£ãƒãƒ«ã«è‡ªå‹•æ›¸ãè¾¼ã¿ã™ã‚‹ã‹

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥è¨­å®š
    notification_config: Optional[NotificationConfig] = None  # é€šçŸ¥è¨­å®š

    def to_dict(self) -> dict[str, Any]:
        """è¾æ›¸ã«å¤‰æ›ï¼ˆã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰"""
        data = self.model_dump()
        data["feedback_type"] = self.feedback_type.value
        if self.notification_config:
            data["notification_config"] = self.notification_config.to_dict()
        return data

    @classmethod
    def from_dict(cls, data: dict[str, Any]) -> "FeedbackRequest":
        """è¾æ›¸ã‹ã‚‰å¾©å…ƒ"""
        data = data.copy()
        data["feedback_type"] = FeedbackType(data["feedback_type"])
        if data.get("notification_config"):
            data["notification_config"] = NotificationConfig.model_validate(data["notification_config"])
        return cls.model_validate(data)
```

#### FeedbackResponse

```python
class FeedbackResponse(BaseModel):
    """ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¿œç­”ã‚’è¡¨ã™"""
    feedback_id: str                    # ãƒªã‚¯ã‚¨ã‚¹ãƒˆID
    response_type: FeedbackType         # å¿œç­”ã®ã‚¿ã‚¤ãƒ—

    # æ‰¿èªå¿œç­”
    approved: Optional[bool] = None
    reason: Optional[str] = None

    # ãƒ†ã‚­ã‚¹ãƒˆå¿œç­”
    text: Optional[str] = None

    # é¸æŠå¿œç­”
    selected: Optional[str] = None
    selected_multiple: Optional[list[str]] = None

    # ã‚«ã‚¹ã‚¿ãƒ å¿œç­”
    custom_data: Optional[dict[str, Any]] = None

    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    responded_at: str = Field(default_factory=lambda: datetime.now().isoformat())
    responded_by: Optional[str] = None  # ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ã‚·ã‚¹ãƒ†ãƒ è­˜åˆ¥å­

    def to_dict(self) -> dict[str, Any]:
        """è¾æ›¸ã«å¤‰æ›ï¼ˆã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰"""
        data = self.model_dump()
        data["response_type"] = self.response_type.value
        return data

    @classmethod
    def from_dict(cls, data: dict[str, Any]) -> "FeedbackResponse":
        """è¾æ›¸ã‹ã‚‰å¾©å…ƒ"""
        data = data.copy()
        data["response_type"] = FeedbackType(data["response_type"])
        return cls.model_validate(data)
```

#### FeedbackManager

```python
class FeedbackManager:
    """ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ°¸ç¶šåŒ–ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨å¿œç­”ã®ç®¡ç†"""

    def __init__(
        self,
        backend: str = "filesystem",
        backend_config: Optional[dict] = None,
        channel_manager: Optional[Any] = None
    ):
        """ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–

        Args:
            backend: "filesystem" ã¾ãŸã¯ "redis"
            backend_config: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å›ºæœ‰ã®è¨­å®š
                - filesystem: {"data_dir": "feedback_data"}
                - redis: {"host": "localhost", "port": 6379, "db": 0, "redis_client": redis.Redis}
            channel_manager: ãƒãƒ£ãƒãƒ«ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ›¸ãè¾¼ã¿ç”¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ChannelManager

        æ³¨æ„:
            - filesystem: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º/ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ãƒ‰æœ¬ç•ªç”¨
            - redis: åˆ†æ•£å®Ÿè¡Œ/æœ¬ç•ªç’°å¢ƒç”¨
        """
        pass

    def request_feedback(
        self,
        task_id: str,
        session_id: str,
        feedback_type: FeedbackType,
        prompt: str,
        options: Optional[list[str]] = None,
        metadata: Optional[dict] = None,
        timeout: float = 180.0,  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3åˆ†
        channel_key: Optional[str] = None,
        write_to_channel: bool = False,
    ) -> FeedbackResponse:
        """ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦æ±‚ã—ã¦å¿œç­”ã‚’å¾…ã¤

        Raises:
            FeedbackTimeoutException: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¶…éæ™‚
        """
        pass

    def provide_feedback(
        self,
        feedback_id: str,
        response: FeedbackResponse,
    ) -> bool:
        """ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¿œç­”ã‚’æä¾›ï¼ˆå¤–éƒ¨APIã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰"""
        pass
```

### TaskExecutionContext API

```python
class TaskExecutionContext:
    def request_feedback(
        self,
        feedback_type: str | FeedbackType,
        prompt: str,
        options: Optional[list[str]] = None,
        metadata: Optional[dict] = None,
        timeout: float = 180.0,  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3åˆ†
        channel_key: Optional[str] = None,
        write_to_channel: bool = False,
    ) -> FeedbackResponse:
        """äººé–“ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦æ±‚"""
        pass

    # ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰
    def request_approval(
        self,
        prompt: str,
        metadata: Optional[dict] = None,
        timeout: float = 180.0,
        channel_key: Optional[str] = None,
        write_to_channel: bool = False,
    ) -> bool:
        """æ‰¿èªã‚’è¦æ±‚ï¼ˆä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰"""
        pass

    def request_text_input(
        self,
        prompt: str,
        metadata: Optional[dict] = None,
        timeout: float = 180.0,
        channel_key: Optional[str] = None,
        write_to_channel: bool = False,
    ) -> str:
        """ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’è¦æ±‚ï¼ˆä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰"""
        pass

    def request_selection(
        self,
        prompt: str,
        options: list[str],
        metadata: Optional[dict] = None,
        timeout: float = 180.0,
        channel_key: Optional[str] = None,
        write_to_channel: bool = False,
    ) -> str:
        """é¸æŠã‚’è¦æ±‚ï¼ˆä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰"""
        pass
```

---

## å®Ÿè£…è©³ç´°

### ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¹ã‚­ãƒ¼ãƒ

#### Filesystemãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«/é–‹ç™ºç’°å¢ƒæ¨å¥¨ï¼‰

```python
# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆå†èµ·å‹•å¾Œã‚‚æ°¸ç¶šåŒ–ï¼‰
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ :
# feedback_data/
#   requests/
#     deploy_task_abc123.json
#     validate_task_def456.json
#   responses/
#     deploy_task_abc123.json

# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹ä¸¦è¡Œåˆ¶å¾¡ã‚’å®Ÿè£…
import fcntl
import json
from pathlib import Path

class FilesystemFeedbackBackend:
    def __init__(self, data_dir: str = "feedback_data"):
        self.data_dir = Path(data_dir)
        self.requests_dir = self.data_dir / "requests"
        self.responses_dir = self.data_dir / "responses"
        self.requests_dir.mkdir(parents=True, exist_ok=True)
        self.responses_dir.mkdir(parents=True, exist_ok=True)

    def store_request(self, request: FeedbackRequest) -> None:
        """ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ä»˜ãã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¿å­˜"""
        file_path = self.requests_dir / f"{request.feedback_id}.json"
        with open(file_path, 'w') as f:
            fcntl.flock(f.fileno(), fcntl.LOCK_EX)
            json.dump(request.to_dict(), f, indent=2, ensure_ascii=False)
            fcntl.flock(f.fileno(), fcntl.LOCK_UN)

    def get_request(self, feedback_id: str) -> Optional[FeedbackRequest]:
        """ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å–å¾—"""
        file_path = self.requests_dir / f"{feedback_id}.json"
        if not file_path.exists():
            return None
        with open(file_path, 'r') as f:
            data = json.load(f)
            return FeedbackRequest.from_dict(data)
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•å¾Œã‚‚æ°¸ç¶šåŒ–
- âœ… å¤–éƒ¨ä¾å­˜ãªã—ï¼ˆRedisãŒä¸è¦ï¼‰
- âœ… ãƒ‡ãƒãƒƒã‚°ãŒç°¡å˜ï¼ˆäººé–“ãŒèª­ã‚ã‚‹JSONï¼‰
- âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹åŸºæœ¬çš„ãªä¸¦è¡Œåˆ¶å¾¡
- âœ… ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã‚„ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ãƒ‰æœ¬ç•ªç’°å¢ƒã«é©åˆ

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ ã‚¯ãƒ­ã‚¹ãƒãƒ¼ãƒ‰ã‚µãƒãƒ¼ãƒˆãªã—ï¼ˆå˜ä¸€ãƒã‚·ãƒ³ã®ã¿ï¼‰
- âŒ Pub/Subé€šçŸ¥ãªã—ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ã®ã¿ï¼‰
- âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ I/Oã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã€ãƒ†ã‚¹ãƒˆã€ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

#### Redisãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆæœ¬ç•ªç’°å¢ƒ/åˆ†æ•£å®Ÿè¡Œæ¨å¥¨ï¼‰

```redis
# ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
HSET feedback:request:deploy_task_abc123
    feedback_id "deploy_task_abc123"
    task_id "deploy_task"
    session_id "session_12345"
    feedback_type "approval"
    prompt "ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ"
    status "pending"
    created_at "2025-01-28T10:00:00Z"
    timeout "180.0"

# å¿œç­”ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
HSET feedback:response:deploy_task_abc123
    feedback_id "deploy_task_abc123"
    response_type "approval"
    approved "true"
    reason "å•é¡Œãªã—"
    responded_at "2025-01-28T10:00:30Z"
    responded_by "user@example.com"

# Pub/Subé€šçŸ¥
PUBLISH feedback:deploy_task_abc123 "completed"

# æœ‰åŠ¹æœŸé™ï¼ˆ7æ—¥ï¼‰
EXPIRE feedback:request:deploy_task_abc123 604800
EXPIRE feedback:response:deploy_task_abc123 604800
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- âœ… ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•å¾Œã‚‚æ°¸ç¶šåŒ–
- âœ… ã‚¯ãƒ­ã‚¹ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ã‚¯ãƒ­ã‚¹ãƒãƒ¼ãƒ‰å¯¾å¿œ
- âœ… Pub/Subé€šçŸ¥ï¼ˆä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼‰
- âœ… çµ„ã¿è¾¼ã¿ã®æœ‰åŠ¹æœŸé™ï¼ˆTTLï¼‰
- âœ… Redis Clusterã«ã‚ˆã‚‹é«˜å¯ç”¨æ€§
- âœ… åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§å®Ÿç¸¾ã‚ã‚Š

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- âŒ Redisã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦
- âŒ ã‚¤ãƒ³ãƒ•ãƒ©è¤‡é›‘æ€§ã®å¢—åŠ 
- âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹**: æœ¬ç•ªç’°å¢ƒã€åˆ†æ•£ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€ãƒãƒ«ãƒãƒãƒ¼ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ¯”è¼ƒ

| æ©Ÿèƒ½ | Filesystem | Redis |
|------|------------|-------|
| **æ°¸ç¶šæ€§** | âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ | âœ… ãƒ¡ãƒ¢ãƒª + æ°¸ç¶šåŒ– |
| **ã‚¯ãƒ­ã‚¹ãƒ—ãƒ­ã‚»ã‚¹** | âš ï¸ åŒä¸€ãƒã‚·ãƒ³ã®ã¿ | âœ… å¯èƒ½ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼‰ |
| **ã‚¯ãƒ­ã‚¹ãƒãƒ¼ãƒ‰** | âŒ ä¸å¯ | âœ… å¯èƒ½ |
| **Pub/Subé€šçŸ¥** | âŒ ãªã— | âœ… ã‚ã‚Š |
| **å¤–éƒ¨ä¾å­˜** | âœ… ãªã— | âŒ Redisã‚µãƒ¼ãƒãƒ¼å¿…è¦ |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«I/O | ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯I/O |
| **ãƒ‡ãƒãƒƒã‚°** | âœ… JSONãƒ•ã‚¡ã‚¤ãƒ« | âš ï¸ Redis CLI |
| **ä¸¦è¡Œåˆ¶å¾¡** | âœ… ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ãƒƒã‚¯ | âœ… Redisã‚¢ãƒˆãƒŸãƒƒã‚¯æ€§ |
| **ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹** | é–‹ç™º/ã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ãƒ‰ | æœ¬ç•ª/åˆ†æ•£ |

**æ¨å¥¨äº‹é …**:
- **é–‹ç™º/ãƒ†ã‚¹ãƒˆ**: `filesystem`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
- **æœ¬ç•ªï¼ˆã‚·ãƒ³ã‚°ãƒ«ãƒãƒ¼ãƒ‰ï¼‰**: `filesystem` ã¾ãŸã¯ `redis`
- **æœ¬ç•ªï¼ˆåˆ†æ•£ï¼‰**: `redis`ï¼ˆå¿…é ˆï¼‰

---

## é€šçŸ¥ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

### ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: Pub/Sub + ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

#### è¨­è¨ˆåŸå‰‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis Storage (Hash) = ä¿¡é ¼ã§ãã‚‹æƒ…å ±æº    â”‚
â”‚  â”œâ”€ feedback:request:xxx                    â”‚
â”‚  â””â”€ feedback:response:xxx  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ å¸¸ã«ã“ã“ã‚’ãƒã‚§ãƒƒã‚¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–²
           â”‚
           â”‚ (ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æœ€é©åŒ–ã®ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«é€šçŸ¥)
           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis Pub/Sub = é€šçŸ¥ã®ã¿                   â”‚
â”‚  â””â”€ feedback:xxx channel                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ã‚·ãƒŠãƒªã‚ªA: ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆåŒæœŸï¼‰

```
ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³:
  0ç§’: ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰
  5ç§’: äººé–“ãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æä¾›
  5ç§’: Pub/Subãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç™ºè¡Œ â†’ ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ãŒå³åº§ã«å—ä¿¡
  5ç§’: ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¿œç­”ã‚’å–å¾—
  5ç§’: ãƒ¯ãƒ¼ã‚«ãƒ¼ç¶™ç¶šï¼ˆç·ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: < 100msï¼‰
```

**çµæœ**: ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· âœ…ï¼ˆPub/Subæœ€é©åŒ–ãŒæ©Ÿèƒ½ï¼‰

#### ã‚·ãƒŠãƒªã‚ªB: ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆéåŒæœŸï¼‰

```
ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³:
  0ç§’: ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
 30ç§’: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ â†’ ãƒ¯ãƒ¼ã‚«ãƒ¼çµ‚äº†ï¼ˆã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼åœæ­¢ï¼‰
  5åˆ†: äººé–“ãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æä¾›
  5åˆ†: Pub/Subãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç™ºè¡Œ â†’ ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ãªã— â†’ å–ªå¤± âŒ
 10åˆ†: ãƒ¯ãƒ¼ã‚«ãƒ¼2ãŒãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å†é–‹
 10åˆ†: ãƒ¯ãƒ¼ã‚«ãƒ¼2ãŒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ â†’ å¿œç­”ç™ºè¦‹ âœ…
 10åˆ†: ãƒ¯ãƒ¼ã‚«ãƒ¼2ç¶™ç¶š
```

**çµæœ**: ä¿¡é ¼æ€§ã®é«˜ã„å†é–‹ âœ…ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæ©Ÿèƒ½ï¼‰

### ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®å®Ÿè£…

```python
def _poll_for_response(self, feedback_id: str, timeout: float):
    """Pub/Subæœ€é©åŒ–ã«ã‚ˆã‚‹ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‰"""

    # ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯å¸¸ã«ä¿¡é ¼ã§ãã‚‹æƒ…å ±æº
    response = self._get_response_from_storage(feedback_id)
    if response:
        return response  # ã™ã§ã«åˆ©ç”¨å¯èƒ½ï¼ˆå†é–‹ã‚±ãƒ¼ã‚¹ï¼‰

    # Pub/Subãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ãƒªãƒ³ã‚°ã®æœ€é©åŒ–ï¼‰
    notification_event = threading.Event()
    pubsub_thread = None

    if self.backend == "redis":
        # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ãƒ¬ãƒƒãƒ‰ã§Pub/Subãƒªã‚¹ãƒŠãƒ¼ã‚’é–‹å§‹
        def pubsub_listener():
            try:
                pubsub = self._redis_client.pubsub()
                pubsub.subscribe(f"feedback:{feedback_id}")

                for message in pubsub.listen():
                    if message["type"] == "message":
                        # é€šçŸ¥å—ä¿¡
                        notification_event.set()
                        break
            except Exception as e:
                # Pub/Subå¤±æ•—ã€å•é¡Œãªã—ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                print(f"[Pub/Sub] ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼: {e}")

        pubsub_thread = threading.Thread(target=pubsub_listener, daemon=True)
        pubsub_thread.start()

    # ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆPub/Subã«é–¢ä¿‚ãªãå¸¸ã«å®Ÿè¡Œï¼‰
    poll_interval = 0.5
    elapsed = 0.0

    while elapsed < timeout:
        # é€šçŸ¥ã¾ãŸã¯ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’å¾…ã¤
        notification_event.wait(timeout=poll_interval)

        # å¸¸ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä¿¡é ¼ã§ãã‚‹æƒ…å ±æºï¼‰
        response = self._get_response_from_storage(feedback_id)
        if response:
            return response  # ç™ºè¦‹

        elapsed += poll_interval

    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    return None
```

### é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

1. **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’æœ€åˆã«ãƒã‚§ãƒƒã‚¯**: å†é–‹ã‚±ãƒ¼ã‚¹ã§ã¯å³åº§ã«å¿œç­”ã‚’ç™ºè¦‹
2. **Pub/Subã¯ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«**: å¤±æ•—ã—ã¦ã‚‚ãƒãƒ¼ãƒªãƒ³ã‚°ã¯æ©Ÿèƒ½
3. **ãƒãƒ¼ãƒªãƒ³ã‚°ã¯å¸¸ã«å®Ÿè¡Œ**: Pub/SubãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚‚
4. **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒä¿¡é ¼ã§ãã‚‹æƒ…å ±æº**: Pub/Subã¯ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’å‰Šæ¸›ã™ã‚‹ã ã‘

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚º                   â”‚
â”‚                                                               â”‚
â”‚  ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰1ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰:                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ while elapsed < timeout:                     â”‚             â”‚
â”‚  â”‚     notification_event.wait(0.5s)            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     response = storage.get(feedback_id)      â”‚         â”‚   â”‚
â”‚  â”‚     if response: return response             â”‚         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚                     â–²                                     â”‚   â”‚
â”‚                     â”‚ 500msã”ã¨ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯        â”‚   â”‚
â”‚                     â”‚                                     â”‚   â”‚
â”‚  ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚¹ãƒ¬ãƒƒãƒ‰2ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰Pub/Subï¼‰:                 â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚ pubsub.subscribe(f"feedback:{id}")           â”‚         â”‚   â”‚
â”‚  â”‚ for message in pubsub.listen():              â”‚         â”‚   â”‚
â”‚  â”‚     if message: notification_event.set() â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ30ç§’ï¼‰
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãƒ•ã‚§ãƒ¼ã‚º                       â”‚
â”‚                                                               â”‚
â”‚  - ãƒ¯ãƒ¼ã‚«ãƒ¼çµ‚äº†ï¼ˆPub/Subã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼åœæ­¢ï¼‰                   â”‚
â”‚  - å¿œç­”ãŒRedisã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆhashï¼‰ã«ä¿å­˜ã•ã‚Œã‚‹                     â”‚
â”‚  - Pub/Subãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç™ºè¡Œï¼ˆãŸã ã—ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ãªã— â†’ å–ªå¤±ï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ å†é–‹ï¼ˆå¾Œã§ï¼‰
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å†é–‹ãƒ•ã‚§ãƒ¼ã‚º                                â”‚
â”‚                                                               â”‚
â”‚  ãƒ¯ãƒ¼ã‚«ãƒ¼2:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ response = storage.get(feedback_id)          â”‚             â”‚
â”‚  â”‚ if response:                                 â”‚             â”‚
â”‚  â”‚     return response  # å³åº§ã«ç™ºè¦‹ âœ…          â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                               â”‚
â”‚  ãƒãƒ¼ãƒªãƒ³ã‚°ä¸è¦ï¼ˆå¿œç­”ã¯ã™ã§ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚ã‚‹ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ

| ã‚·ãƒŠãƒªã‚ª | Pub/Subã®ã¿ | ãƒãƒ¼ãƒªãƒ³ã‚°ã®ã¿ | ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ |
|----------|------------|--------------|------------|
| **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆ1ç§’ä»¥å†…ã«å¿œç­”ï¼‰** | < 100ms | < 500ms | < 100ms âœ… |
| **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆ10ç§’ä»¥å†…ã«å¿œç­”ï¼‰** | < 100ms | < 500ms | < 100ms âœ… |
| **å†é–‹ï¼ˆå¿œç­”åˆ©ç”¨å¯èƒ½ï¼‰** | N/A | 0msï¼ˆå³åº§ï¼‰ | 0msï¼ˆå³åº§ï¼‰ âœ… |

---

## ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

### æ¦‚è¦

ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã¯ä»¥ä¸‹ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ï¼š

1. **ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›**: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã®è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
2. **æ±ç”¨Webhook**: Slackã€Discordã€Microsoft Teamsã€ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç­‰ã¸ã® HTTPé€šçŸ¥
3. **ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼**: Pythoné–¢æ•°ã«ã‚ˆã‚‹ä»»æ„ã®é€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯

### ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL

ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä½œæˆã•ã‚Œã‚‹ã¨ã€ä¸€æ„ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯IDãŒç”Ÿæˆã•ã‚Œã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLãŒæ§‹ç¯‰ã•ã‚Œã¾ã™ï¼š

```
{api_base_url}/api/feedback/{feedback_id}/respond
```

ä¾‹ï¼š
```
https://api.example.com/api/feedback/deploy_task_a1b2c3d4/respond
```

### é€šçŸ¥å®Ÿè£…

#### FeedbackManagerã®æ‹¡å¼µ

```python
class FeedbackManager:
    def request_feedback(
        self,
        task_id: str,
        session_id: str,
        feedback_type: FeedbackType,
        prompt: str,
        options: Optional[list[str]] = None,
        metadata: Optional[dict] = None,
        timeout: float = 180.0,
        channel_key: Optional[str] = None,
        write_to_channel: bool = False,
        notification_config: Optional[NotificationConfig] = None,  # NEW
    ) -> FeedbackResponse:
        """ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¦æ±‚ã—ã¦å¿œç­”ã‚’å¾…ã¤"""

        # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
        feedback_id = f"{task_id}_{uuid.uuid4().hex[:8]}"
        request = FeedbackRequest(
            feedback_id=feedback_id,
            task_id=task_id,
            session_id=session_id,
            feedback_type=feedback_type,
            prompt=prompt,
            options=options,
            metadata=metadata or {},
            timeout=timeout,
            status="pending",
            channel_key=channel_key,
            write_to_channel=write_to_channel,
            notification_config=notification_config,  # NEW
        )
        self._store_request(request)

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã‚’é€ä¿¡
        self._send_user_notification(request)  # NEW

        # ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        response = self._poll_for_response(feedback_id, timeout)
        # ...

    def _send_user_notification(self, request: FeedbackRequest) -> None:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã‚’é€ä¿¡"""
        if not request.notification_config:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
            self._send_console_notification(request)
            return

        config = request.notification_config
        notification_type = config.notification_type

        try:
            if notification_type == NotificationType.CONSOLE:
                self._send_console_notification(request)
            elif notification_type == NotificationType.WEBHOOK:
                self._send_webhook_notification(request, config)
            elif notification_type == NotificationType.CUSTOM:
                self._send_custom_notification(request, config)
        except Exception as e:
            print(f"[FeedbackManager] é€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
            # é€šçŸ¥å¤±æ•—ã—ã¦ã‚‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ç¶™ç¶š

    def _send_console_notification(self, request: FeedbackRequest) -> None:
        """ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«é€šçŸ¥ã‚’è¡¨ç¤º"""
        api_url = self._build_feedback_url(request)

        print("=" * 80)
        print(f"ğŸ”” ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: {request.feedback_id}")
        print(f"ã‚¿ã‚¤ãƒ—: {request.feedback_type.value}")
        print(f"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {request.prompt}")
        if request.options:
            print(f"ã‚ªãƒ—ã‚·ãƒ§ãƒ³: {', '.join(request.options)}")
        print(f"ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: {request.timeout}ç§’")
        print()
        print(f"ğŸ“‹ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:")
        print(f"   {api_url}")
        print()
        print("ä¾‹:")
        print(f'  curl -X POST {api_url} \\')
        print('    -H "Content-Type: application/json" \\')
        if request.feedback_type == FeedbackType.APPROVAL:
            print('    -d \'{"approved": true, "reason": "æ‰¿èª"}\'')
        elif request.feedback_type == FeedbackType.TEXT:
            print('    -d \'{"text": "ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ†ã‚­ã‚¹ãƒˆ"}\'')
        elif request.feedback_type == FeedbackType.SELECTION:
            print(f'    -d \'{{"selected": "{request.options[0] if request.options else "option1"}"}}\'')
        print("=" * 80)

    def _send_webhook_notification(
        self,
        request: FeedbackRequest,
        config: NotificationConfig
    ) -> None:
        """æ±ç”¨Webhookã«é€šçŸ¥ã‚’é€ä¿¡ï¼ˆSlack, Discord, Teams, ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå¯¾å¿œï¼‰"""
        import requests
        import hmac
        import hashlib
        import json

        if not config.webhook_url:
            raise ValueError("Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

        api_url = self._build_feedback_url(request)

        # Webhookãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ§‹ç¯‰
        if config.webhook_payload_template:
            # ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½¿ç”¨ï¼ˆJinja2ç­‰ï¼‰
            try:
                from jinja2 import Template
                template = Template(config.webhook_payload_template)
                payload_str = template.render(
                    feedback_id=request.feedback_id,
                    task_id=request.task_id,
                    session_id=request.session_id,
                    feedback_type=request.feedback_type.value,
                    prompt=request.prompt,
                    options=request.options,
                    timeout=request.timeout,
                    api_url=api_url,
                    created_at=request.created_at,
                    metadata=request.metadata,
                )
                payload = json.loads(payload_str)
            except ImportError:
                print("[FeedbackManager] Jinja2ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™")
                payload = self._build_default_payload(request, api_url)
        else:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆæ±ç”¨JSONå½¢å¼ï¼‰
            payload = self._build_default_payload(request, api_url)

        # ãƒ˜ãƒƒãƒ€ãƒ¼
        headers = config.webhook_headers or {}
        headers.setdefault("Content-Type", "application/json")

        # HMACç½²åï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
        if config.webhook_secret:
            payload_bytes = json.dumps(payload, ensure_ascii=False).encode('utf-8')
            signature = hmac.new(
                config.webhook_secret.encode(),
                payload_bytes,
                hashlib.sha256
            ).hexdigest()
            headers["X-Graflow-Signature"] = signature

        # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
        for attempt in range(config.webhook_retry_count):
            try:
                response = requests.request(
                    method=config.webhook_method,
                    url=config.webhook_url,
                    json=payload,
                    headers=headers,
                    timeout=config.webhook_timeout
                )
                if response.status_code < 300:
                    print(f"[FeedbackManager] Webhooké€šçŸ¥é€ä¿¡æˆåŠŸ: {config.webhook_url}")
                    return
                else:
                    print(f"[FeedbackManager] Webhookå¤±æ•— (HTTP {response.status_code}): {response.text}")
            except Exception as e:
                print(f"[FeedbackManager] Webhookã‚¨ãƒ©ãƒ¼ (è©¦è¡Œ {attempt + 1}/{config.webhook_retry_count}): {e}")
                if attempt < config.webhook_retry_count - 1:
                    import time
                    time.sleep(2 ** attempt)  # æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•

        print(f"[FeedbackManager] Webhooké€ä¿¡å¤±æ•—ï¼ˆå…¨è©¦è¡Œçµ‚äº†ï¼‰: {config.webhook_url}")

    def _build_default_payload(
        self,
        request: FeedbackRequest,
        api_url: str
    ) -> dict:
        """ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆWebhookãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰ï¼ˆæ±ç”¨JSONå½¢å¼ï¼‰"""
        return {
            "event": "feedback_requested",
            "feedback_id": request.feedback_id,
            "task_id": request.task_id,
            "session_id": request.session_id,
            "feedback_type": request.feedback_type.value,
            "prompt": request.prompt,
            "options": request.options,
            "timeout": request.timeout,
            "api_url": api_url,
            "created_at": request.created_at,
            "metadata": request.metadata,
        }

    def _send_custom_notification(
        self,
        request: FeedbackRequest,
        config: NotificationConfig
    ) -> None:
        """ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§é€šçŸ¥ã‚’é€ä¿¡"""
        if not config.custom_handler:
            raise ValueError("ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

        api_url = self._build_feedback_url(request)

        # ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã™
        config.custom_handler(
            feedback_request=request,
            api_url=api_url
        )

        print(f"[FeedbackManager] ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥é€ä¿¡: {request.feedback_id}")

    def _build_feedback_url(self, request: FeedbackRequest) -> str:
        """ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã‚’æ§‹ç¯‰"""
        if request.notification_config and request.notification_config.api_base_url:
            base_url = request.notification_config.api_base_url.rstrip("/")
        else:
            base_url = "http://localhost:8000"  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

        return f"{base_url}/api/feedback/{request.feedback_id}/respond"
```

### ä½¿ç”¨ä¾‹

#### ä¾‹1: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«é€šçŸ¥ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

```python
@task(inject_context=True)
def approval_task(context):
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ç¤º
    response = context.request_approval(
        prompt="ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ",
        timeout=180
    )
    return response
```

#### ä¾‹2: Slack Webhooké€šçŸ¥

```python
from graflow.hitl.types import NotificationConfig, NotificationType
import json

@task(inject_context=True)
def approval_with_slack(context):
    # Slack Incoming Webhookç”¨ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆJinja2å½¢å¼ï¼‰
    slack_template = """
    {
        "text": "ğŸ”” *ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ*",
        "blocks": [
            {
                "type": "header",
                "text": {
                    "type": "plain_text",
                    "text": "ğŸ”” ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ",
                    "emoji": true
                }
            },
            {
                "type": "section",
                "fields": [
                    {"type": "mrkdwn", "text": "*ã‚¿ã‚¤ãƒ—:*\\n{{ feedback_type }}"},
                    {"type": "mrkdwn", "text": "*ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:*\\n{{ timeout }}ç§’"},
                    {"type": "mrkdwn", "text": "*ã‚¿ã‚¹ã‚¯ID:*\\n`{{ task_id }}`"},
                    {"type": "mrkdwn", "text": "*ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ID:*\\n`{{ feedback_id }}`"}
                ]
            },
            {
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": "*ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:*\\n{{ prompt }}"
                }
            },
            {
                "type": "section",
                "text": {
                    "type": "mrkdwn",
                    "text": "*ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:*\\n<{{ api_url }}|{{ api_url }}>"
                }
            }
        ]
    }
    """

    notification_config = NotificationConfig(
        notification_type=NotificationType.WEBHOOK,
        api_base_url="https://api.example.com",
        webhook_url="https://hooks.slack.com/services/YOUR/WEBHOOK/URL",
        webhook_payload_template=slack_template
    )

    response = context.request_feedback(
        feedback_type=FeedbackType.APPROVAL,
        prompt="æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ",
        timeout=300,
        notification_config=notification_config
    )
    return response
```

#### ä¾‹3: Discord Webhooké€šçŸ¥

```python
@task(inject_context=True)
def approval_with_discord(context):
    # Discord Webhookç”¨ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    discord_template = """
    {
        "embeds": [{
            "title": "ğŸ”” ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ",
            "color": 5814783,
            "fields": [
                {"name": "ã‚¿ã‚¤ãƒ—", "value": "{{ feedback_type }}", "inline": true},
                {"name": "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ", "value": "{{ timeout }}ç§’", "inline": true},
                {"name": "ã‚¿ã‚¹ã‚¯ID", "value": "`{{ task_id }}`", "inline": false},
                {"name": "ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ", "value": "{{ prompt }}", "inline": false},
                {"name": "APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ", "value": "[ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡]({{ api_url }})", "inline": false}
            ],
            "timestamp": "{{ created_at }}"
        }]
    }
    """

    notification_config = NotificationConfig(
        notification_type=NotificationType.WEBHOOK,
        api_base_url="https://api.example.com",
        webhook_url="https://discord.com/api/webhooks/YOUR/WEBHOOK/URL",
        webhook_payload_template=discord_template
    )

    response = context.request_feedback(
        feedback_type=FeedbackType.APPROVAL,
        prompt="æ‰¿èªãŒå¿…è¦ã§ã™",
        timeout=180,
        notification_config=notification_config
    )
    return response
```

#### ä¾‹4: ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæ±ç”¨JSONï¼‰

```python
@task(inject_context=True)
def approval_with_custom_endpoint(context):
    notification_config = NotificationConfig(
        notification_type=NotificationType.WEBHOOK,
        api_base_url="https://api.example.com",
        webhook_url="https://your-system.com/api/notifications",
        webhook_method="POST",
        webhook_headers={"Authorization": "Bearer YOUR_TOKEN"},
        webhook_secret="your-hmac-secret",  # HMACç½²åç”¨
        webhook_retry_count=3,
        webhook_timeout=10
        # webhook_payload_templateã‚’æŒ‡å®šã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä½¿ç”¨
    )

    response = context.request_feedback(
        feedback_type=FeedbackType.APPROVAL,
        prompt="æ‰¿èªãŒå¿…è¦ã§ã™",
        timeout=180,
        notification_config=notification_config
    )
    return response
```

#### ä¾‹5: ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

```python
def my_custom_notifier(feedback_request, api_url):
    """ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯"""
    # ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    send_email(
        to="admin@example.com",
        subject=f"ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: {feedback_request.task_id}",
        body=f"ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: {feedback_request.prompt}\nAPI URL: {api_url}"
    )

    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²
    db.insert("notifications", {
        "feedback_id": feedback_request.feedback_id,
        "api_url": api_url,
        "created_at": feedback_request.created_at
    })

@task(inject_context=True)
def approval_with_custom(context):
    notification_config = NotificationConfig(
        notification_type=NotificationType.CUSTOM,
        api_base_url="https://api.example.com",
        custom_handler=my_custom_notifier
    )

    response = context.request_feedback(
        feedback_type=FeedbackType.APPROVAL,
        prompt="ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥ãƒ†ã‚¹ãƒˆ",
        timeout=180,
        notification_config=notification_config
    )
    return response
```

### Webhooké€šçŸ¥ä¾‹

#### Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹

Slack Webhooké€šçŸ¥ï¼ˆä¾‹2ï¼‰ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªãƒƒãƒãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
ğŸ”” ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ã‚¿ã‚¤ãƒ—:                  ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ:
approval                 300ç§’

ã‚¿ã‚¹ã‚¯ID:                ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ID:
deploy_task              deploy_task_a1b2c3d4

ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:
æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ

ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:
https://api.example.com/api/feedback/deploy_task_a1b2c3d4/respond
```

#### Discordé€šçŸ¥ä¾‹

Discord Webhooké€šçŸ¥ï¼ˆä¾‹3ï¼‰ãŒé€ä¿¡ã•ã‚Œã‚‹ã¨ã€Embedãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

#### ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ï¼ˆä¾‹4ï¼‰

ã‚«ã‚¹ã‚¿ãƒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æŒ‡å®šã—ãªã„å ´åˆã€ä»¥ä¸‹ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãŒé€ä¿¡ã•ã‚Œã¾ã™ï¼š

```json
{
  "event": "feedback_requested",
  "feedback_id": "deploy_task_a1b2c3d4",
  "task_id": "deploy_task",
  "session_id": "session_12345",
  "feedback_type": "approval",
  "prompt": "æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ",
  "options": null,
  "timeout": 300,
  "api_url": "https://api.example.com/api/feedback/deploy_task_a1b2c3d4/respond",
  "created_at": "2025-01-28T10:00:00Z",
  "metadata": {}
}
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

#### HMACç½²åæ¤œè¨¼ï¼ˆWebhookå—ä¿¡å´ï¼‰

```python
import hmac
import hashlib
from fastapi import Request, HTTPException

@app.post("/api/notifications")
async def receive_graflow_notification(request: Request):
    # ç½²åã‚’å–å¾—
    signature = request.headers.get("X-Graflow-Signature")
    if not signature:
        raise HTTPException(401, "ç½²åãŒã‚ã‚Šã¾ã›ã‚“")

    # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹
    body = await request.body()

    # ç½²åã‚’æ¤œè¨¼
    expected_signature = hmac.new(
        WEBHOOK_SECRET.encode(),
        body,
        hashlib.sha256
    ).hexdigest()

    if not hmac.compare_digest(signature, expected_signature):
        raise HTTPException(401, "ç„¡åŠ¹ãªç½²å")

    # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å‡¦ç†
    payload = await request.json()
    print(f"ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡: {payload['feedback_id']}")

    # å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯...

    return {"status": "ok"}
```

---

## ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆçµ±åˆ

### ä¿ç•™ä¸­ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ

ã‚¿ã‚¹ã‚¯ãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å¾…ã£ã¦ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¦çµ‚äº†ã—ã¾ã™ï¼š

```python
# ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆçŠ¶æ…‹ã«ã¯ä¿ç•™ä¸­ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå«ã¾ã‚Œã‚‹
{
    "schema_version": "1.0",
    "session_id": "session_12345",
    "pending_tasks": [
        {
            "task_id": "deploy_task",
            "status": "waiting_feedback",  # ç‰¹åˆ¥ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
            "feedback_id": "deploy_task_abc123",  # ä¿ç•™ä¸­ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¸ã®å‚ç…§
        }
    ],
}
```

### å†é–‹ãƒ•ãƒ­ãƒ¼

```
1. äººé–“ãŒAPIã§ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æä¾›
   POST /api/feedback/deploy_task_abc123/respond
   â†’ FeedbackManagerãŒå¿œç­”ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ä¿å­˜

2. ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†é–‹
   context, metadata = CheckpointManager.resume_from_checkpoint(path)
   engine.execute(context)

3. ã‚¨ãƒ³ã‚¸ãƒ³ãŒä¿ç•™ä¸­ã®ã‚¿ã‚¹ã‚¯ï¼ˆdeploy_taskï¼‰ã‹ã‚‰å†èµ·å‹•

4. ã‚¿ã‚¹ã‚¯ãŒå†åº¦request_feedback()ã‚’å‘¼ã³å‡ºã™
   response = context.request_feedback(...)

5. FeedbackManagerãŒæ—¢å­˜ã®å¿œç­”ã‚’ç™ºè¦‹
   â†’ å³åº§ã«è¿”ã™ï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ãªã—ï¼‰

6. ã‚¿ã‚¹ã‚¯ãŒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ã¨ã‚‚ã«ç¶™ç¶š
```

---

## ã‚¯ãƒ­ã‚¹ãƒ—ãƒ­ã‚»ã‚¹é€šä¿¡

### ã‚¯ãƒ­ã‚¹ãƒ—ãƒ­ã‚»ã‚¹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ­ã‚»ã‚¹                           â”‚
â”‚                                                              â”‚
â”‚  WorkflowEngine â†’ Task â†’ FeedbackManager                    â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â”œâ”€> Redisã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ          â”‚
â”‚                           â”œâ”€> Redis Pub/Subã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–  â”‚
â”‚                           â”œâ”€> å¿œç­”ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ3åˆ†ï¼‰         â”‚
â”‚                           â””â”€> ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ â†’ çµ‚äº†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â–²
                               â”‚ Redis
                               â”‚ (feedback:request:*, feedback:response:*)
                               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APIã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒ­ã‚»ã‚¹                        â”‚
â”‚                                                              â”‚
â”‚  FastAPI â†’ FeedbackAPI                                      â”‚
â”‚              â”‚                                               â”‚
â”‚              â”œâ”€> GET /feedback (ä¿ç•™ä¸­ä¸€è¦§)                  â”‚
â”‚              â”œâ”€> POST /feedback/{id}/respond                â”‚
â”‚              â”‚     â””â”€> Redisã«å¿œç­”ã‚’ä¿å­˜                     â”‚
â”‚              â”‚     â””â”€> Redis Pub/Subã«ç™ºè¡Œ                  â”‚
â”‚              â””â”€> GET /feedback/{id} (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### REST APIè¨­è¨ˆ

#### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```bash
# ä¿ç•™ä¸­ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ä¸€è¦§
GET /api/feedback?session_id={session_id}

# ç‰¹å®šã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå–å¾—
GET /api/feedback/{feedback_id}

# æ‰¿èª
POST /api/feedback/{feedback_id}/respond
{
  "approved": true,
  "reason": "ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ã‚ˆã‚Šæ‰¿èª",
  "responded_by": "alice@example.com"
}

# ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æä¾›
POST /api/feedback/{feedback_id}/respond
{
  "text": "ã‚»ã‚¯ã‚·ãƒ§ãƒ³3ã®ã‚¿ã‚¤ãƒã‚’ä¿®æ­£ã—ã¦ãã ã•ã„",
  "responded_by": "bob@example.com"
}

# é¸æŠ
POST /api/feedback/{feedback_id}/respond
{
  "selected": "option_b",
  "responded_by": "charlie@example.com"
}

# ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
DELETE /api/feedback/{feedback_id}
```

---

## ä½¿ç”¨ä¾‹

### ä¾‹1: åŸºæœ¬çš„ãªæ‰¿èªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

```python
from graflow.core.workflow import workflow
from graflow.core.decorators import task

@task(inject_context=True)
def request_approval_task(context):
    try:
        response = context.request_approval(
            prompt="æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ",
            timeout=180  # 3åˆ†
        )
        if response:
            print("æ‰¿èªã•ã‚Œã¾ã—ãŸï¼ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™")
            return "deployed"
        else:
            print("æ‹’å¦ã•ã‚Œã¾ã—ãŸ")
            return "cancelled"
    except FeedbackTimeoutException:
        # ã“ã‚Œã¯ã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚ˆã£ã¦ã‚­ãƒ£ãƒƒãƒã•ã‚Œã€ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã™
        raise

with workflow("deployment") as wf:
    request_approval_task()
    wf.execute()
```

### ä¾‹2: ãƒãƒ£ãƒãƒ«çµ±åˆ

```python
@task(inject_context=True)
def approval_with_channel(context):
    # ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¿œç­”ã‚’è‡ªå‹•çš„ã«ãƒãƒ£ãƒãƒ«ã«æ›¸ãè¾¼ã‚€
    response = context.request_approval(
        prompt="ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ",
        channel_key="deployment_approved",
        write_to_channel=True,
        timeout=180
    )
    # å¿œç­”ã¯è‡ªå‹•çš„ã«channel["deployment_approved"]ã«æ›¸ãè¾¼ã¾ã‚Œã¾ã™
    return response

@task(inject_context=True)
def execute_deployment(context):
    # ä»–ã®ã‚¿ã‚¹ã‚¯ãŒãƒãƒ£ãƒãƒ«ã‹ã‚‰æ‰¿èªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’èª­ã¿å–ã‚Œã¾ã™
    approved = context.channel.get("deployment_approved")
    if approved:
        deploy()
```

### ä¾‹3: ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›

```python
@task(inject_context=True)
def request_review_comments(context):
    comments = context.request_text_input(
        prompt="ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã«ã¤ã„ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
        timeout=300  # 5åˆ†
    )
    print(f"ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ: {comments}")
    return comments
```

### ä¾‹4: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å†é–‹

```python
# åˆå›å®Ÿè¡Œ
with workflow("deployment") as wf:
    @task(inject_context=True)
    def deploy(context):
        response = context.request_approval(
            prompt="æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ",
            timeout=180  # 3åˆ†
        )
        if response.approved:
            execute_deployment()
        else:
            cancel_deployment()

    try:
        wf.execute()
    except SystemExit:
        # ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å¾…ã¡
        pass

# ï¼ˆå¾Œã§ï¼‰äººé–“ãŒAPIã§æ‰¿èª
# POST /api/feedback/deploy_abc123/respond
# {"approved": true, "reason": "ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ã‚ˆã‚Šæ‰¿èª"}

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†é–‹
from graflow.core.checkpoint import CheckpointManager
from graflow.core.engine import WorkflowEngine

context, metadata = CheckpointManager.resume_from_checkpoint(
    "checkpoints/session_12345_step_5.pkl"
)

engine = WorkflowEngine()
engine.execute(context)
# ã‚¿ã‚¹ã‚¯ãŒå†é–‹ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç™ºè¦‹ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã¨ã‚‚ã«ç¶™ç¶š
```

---

## ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã¨åˆ¶é™äº‹é …

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

1. **Pub/Subèµ·å‹•å¤±æ•—**
   ```python
   try:
       pubsub_thread.start()
   except Exception:
       pass  # å•é¡Œãªã—ã€ãƒãƒ¼ãƒªãƒ³ã‚°ã¯æ©Ÿèƒ½ã™ã‚‹
   ```
   **çµæœ**: ãƒãƒ¼ãƒªãƒ³ã‚°ã®ã¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ âœ…

2. **Pub/Subãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–ªå¤±**
   ```
   ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒãƒ¼ãŒé…ãèµ·å‹• â†’ Pub/Subãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã™ã§ã«ç™ºè¡Œæ¸ˆã¿ â†’ å–ªå¤±
   ```
   **çµæœ**: ãƒãƒ¼ãƒªãƒ³ã‚°ãŒã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ç™ºè¦‹ âœ…

3. **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯å¤±æ•—**
   ```python
   try:
       response = storage.get(feedback_id)
   except Exception:
       # ãƒªãƒˆãƒ©ã‚¤ã¾ãŸã¯å¤±æ•—
   ```
   **çµæœ**: å®Ÿéš›ã®ã‚¨ãƒ©ãƒ¼ï¼ˆä¿¡é ¼ã§ãã‚‹æƒ…å ±æºãŒåˆ©ç”¨ä¸å¯ï¼‰âŒ

4. **ä¸¦è¡Œå†é–‹**
   ```
   ãƒ¯ãƒ¼ã‚«ãƒ¼1: å†é–‹ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ â†’ ç™ºè¦‹
   ãƒ¯ãƒ¼ã‚«ãƒ¼2: å†é–‹ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ â†’ ç™ºè¦‹ï¼ˆå†ªç­‰ï¼‰
   ```
   **çµæœ**: ä¸¡æ–¹ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒå®‰å…¨ã«å¿œç­”ã‚’å–å¾— âœ…

### åˆ¶é™äº‹é …

1. **ãƒ¡ãƒ¢ãƒªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•å¾Œã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–ªå¤±ï¼ˆé–‹ç™ºã®ã¿ï¼‰
2. **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯å³å¯†**: ãƒãƒ¼ãƒªãƒ³ã‚°ã¯è¨­å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã«åœæ­¢
3. **Pub/Subã¯æœ€é©åŒ–**: ä¿¡é ¼ã§ãã‚‹æƒ…å ±æºã§ã¯ãªãã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å‰Šæ¸›ã®ã¿
4. **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚µã‚¤ã‚º**: å¤§ããªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¯ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å¢—ã‚„ã™å¯èƒ½æ€§

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ•ã‚§ãƒ¼ã‚º1: ã‚³ã‚¢æ©Ÿèƒ½ï¼ˆPub/Sub + ãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰

- [ ] `FeedbackType`åˆ—æŒ™å‹
- [ ] `FeedbackRequest`ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹
- [ ] `FeedbackResponse`ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹
- [ ] `FeedbackTimeoutException`
- [ ] `FeedbackManager`
  - [ ] Filesystemãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  - [ ] Redisãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…
  - [ ] ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆPub/Sub + ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
  - [ ] `request_feedback()`ãƒ¡ã‚½ãƒƒãƒ‰
  - [ ] `provide_feedback()`ãƒ¡ã‚½ãƒƒãƒ‰
  - [ ] `list_pending_requests()`ãƒ¡ã‚½ãƒƒãƒ‰
- [ ] `TaskExecutionContext`çµ±åˆ
  - [ ] `request_feedback()`ãƒ¡ã‚½ãƒƒãƒ‰
  - [ ] `request_approval()`ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰
  - [ ] `request_text_input()`ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰
  - [ ] `request_selection()`ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰
- [ ] `ExecutionContext`çµ±åˆ
  - [ ] `feedback_manager`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  - [ ] `create()`ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰
- [ ] `WorkflowEngine`çµ±åˆ
  - [ ] `FeedbackTimeoutException`ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
  - [ ] ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆä½œæˆ
- [ ] ãƒãƒ£ãƒãƒ«çµ±åˆ
  - [ ] `channel_key`ã¨`write_to_channel`ã‚µãƒãƒ¼ãƒˆ
  - [ ] `provide_feedback()`ã§ã®è‡ªå‹•ãƒãƒ£ãƒãƒ«æ›¸ãè¾¼ã¿

### ãƒ•ã‚§ãƒ¼ã‚º2: REST API

- [ ] Pydanticã‚¹ã‚­ãƒ¼ãƒï¼ˆ`graflow/api/schemas/feedback.py`ï¼‰
- [ ] APIãƒ«ãƒ¼ã‚¿ãƒ¼ï¼ˆ`graflow/api/endpoints/feedback.py`ï¼‰
  - [ ] `GET /api/feedback` - ä¿ç•™ä¸­ãƒªã‚¹ãƒˆ
  - [ ] `GET /api/feedback/{feedback_id}` - è©³ç´°å–å¾—
  - [ ] `POST /api/feedback/{feedback_id}/respond` - å¿œç­”æä¾›
  - [ ] `DELETE /api/feedback/{feedback_id}` - ã‚­ãƒ£ãƒ³ã‚»ãƒ«
- [ ] FastAPIã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ`graflow/api/app.py`ï¼‰
  - [ ] `create_feedback_api()`ãƒ•ã‚¡ã‚¯ãƒˆãƒª
  - [ ] ä¾å­˜æ€§æ³¨å…¥ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  - [ ] `endpoints/feedback.py`ã‹ã‚‰ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰
- [ ] ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åˆæœŸåŒ–ï¼ˆ`graflow/api/__init__.py`ï¼‰
  - [ ] æœ€å°é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`__all__ = []`ï¼‰
  - [ ] ä½¿ç”¨æ–¹æ³•ã®docstring

### ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ†ã‚¹ãƒˆã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆ
  - [ ] `FeedbackManager`ãƒ†ã‚¹ãƒˆï¼ˆMemoryã¨Redisï¼‰
  - [ ] ãƒãƒ¼ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ
  - [ ] Pub/Subçµ±åˆãƒ†ã‚¹ãƒˆ
  - [ ] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ãƒ†ã‚¹ãƒˆ
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆ
  - [ ] ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
  - [ ] ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ/å†é–‹ãƒ†ã‚¹ãƒˆ
  - [ ] åˆ†æ•£ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ†ã‚¹ãƒˆ
  - [ ] APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
  - [ ] APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
  - [ ] ä½¿ç”¨ä¾‹
  - [ ] ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚¬ã‚¤ãƒ‰

### ãƒ•ã‚§ãƒ¼ã‚º4: å°†æ¥ã®æ‹¡å¼µï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰

- [ ] Webhookã‚µãƒãƒ¼ãƒˆ
  - [ ] `webhook_url`è¨­å®š
  - [ ] HMACç½²åæ¤œè¨¼
  - [ ] ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯
- [ ] Web UIç”¨SSE
  - [ ] SSEã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
  - [ ] ãƒ–ãƒ©ã‚¦ã‚¶EventSourceçµ±åˆ
- [ ] OAuth 2.0èªè¨¼
  - [ ] JWTãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
  - [ ] ã‚¹ã‚³ãƒ¼ãƒ—ãƒ™ãƒ¼ã‚¹ã®æ¨©é™
  - [ ] èªè¨¼ä¾å­˜æ€§

---

## ã¾ã¨ã‚

ã“ã®HITLè¨­è¨ˆã¯ã€ä»¥ä¸‹ã‚’å®Ÿç¾ã—ã¾ã™ï¼š

1. **æŸ”è»Ÿæ€§**: è¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒ—ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆMemory/Redisï¼‰
2. **ä¿¡é ¼æ€§**: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆPub/Subæœ€é©åŒ– + ãƒãƒ¼ãƒªãƒ³ã‚°ä¿¡é ¼æ€§ï¼‰
3. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: åˆ†æ•£ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã‚¯ãƒ­ã‚¹ãƒ—ãƒ­ã‚»ã‚¹é€šä¿¡
4. **ä½¿ã„ã‚„ã™ã•**: ã‚·ãƒ³ãƒ—ãƒ«ãªAPIã¨ä¾¿åˆ©ãƒ¡ã‚½ãƒƒãƒ‰
5. **çµ±åˆæ€§**: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã€ãƒãƒ£ãƒãƒ«ã€æ—¢å­˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ©Ÿèƒ½ã¨ã®ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªçµ±åˆ

**æ¨å¥¨å®Ÿè£…**: ãƒ•ã‚§ãƒ¼ã‚º1ï¼ˆã‚³ã‚¢ + ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰é€šçŸ¥ï¼‰ã‹ã‚‰é–‹å§‹ã—ã€å¿…è¦ã«å¿œã˜ã¦APIã€Webhookã€SSeã‚’è¿½åŠ ã€‚

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: è¨­è¨ˆç¢ºå®š âœ…
**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: ãƒ•ã‚§ãƒ¼ã‚º1ã®å®Ÿè£…é–‹å§‹
